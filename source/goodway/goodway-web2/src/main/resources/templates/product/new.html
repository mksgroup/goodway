<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="fragments/head"></th:block>
</head>
<body class="horizontal-layout horizontal-top-icon-menu 2-columns   menu-expanded" data-open="hover" data-menu="horizontal-menu" data-col="2-columns">
  <!-- fixed-top-->
    <th:block th:include="fragments/nav"></th:block>
  <!-- ////////////////////////////////////////////////////////////////////////////-->
  <!-- Horizontal navigation-->
    <th:block th:include="fragments/hnav"></th:block>
  <!-- Horizontal navigation-->

  <th:block th:include="fragments/product/new"></th:block>
  
  <th:block th:include="fragments/footer"></th:block>
   <script>
   var errorSbm = false;
        var dataProducts = [],numValidate;
        var deletedIds = [];
        var hotProduct = null;
		var valid1 = true;

		numValidate = function(value, callback){
			setTimeout(function(){
				if(/^[\d]{0,10}$/.test(value) || value == ''){
					callback(true);
// 					$("#save").show();
				} else {
					
					callback(false);
// 					$("#save").hide();
				}
			});
		};

		lengthDes = function(value, callback){
			setTimeout(function(){
				if(/^[a-zA-Z0-9\s]{0,1024}$/.test(value) || value == ''){
					callback(true);
			
// 					$("#save").show();
				} else {
					
					
					callback(false);
// 					$("#save").hide();
				}
			});
		}

		lengthName = function(value, callback){
			setTimeout(function(){
				if(/^[a-zA-Z0-9\s]{0,128}$/.test(value) || value == ''){
					callback(true);
					
// 					$("#save").show();
				} else {
					
					callback(false);
// 					$("#save").hide();
				}
			});
		}
		
		
        $(function() {
        	
        	var containerProduct = document.getElementById('tableProduct');

        	hotProduct = new Handsontable(containerProduct, {
                data: dataProducts,
                colHeaders: ["ID", "Tên sản phẩm", "Mô tả", "Cao (m)", "Rộng (m)", "Dài (m)", "Trọng lượng (kg)"],
                colWidths: [50, 250, 250, 100, 100, 100,120],
                minRows: 10,
                currentRowClassName: 'currentRow',
                currentColClassName: 'currentCol',
            	manualColumnResize: true,
                manualRowResize: true,
                rowHeaders: true,
                contextMenu: ['remove_row'],
                columns: [
                	{data: 'id', readOnly: true},
                    {data: 'name',
                        validator: lengthName},
                    {data: 'description',
                        validator: lengthDes},
                    {data: 'height',
             		 validator: numValidate,
             		 allowInvalid: false},
                    {data: 'width',
                     
             		 validator: numValidate,
                	 allowInvalid: false
                    },
                    {data: 'length',
                    
                	 validator: numValidate,
                	 allowInvalid: false},
                    {data: 'weight',
                	 
                 	 validator: numValidate,
                 	 allowInvalid: false
					}
                  ],
                  
				  afterChange: function(changes, source){
					if(source === "loadData"){
						return;
					}
					  
					console.log("changes : "+changes);
					console.log("source : "+source);

					console.log('step');
					
					
					if(changes != null){
						document.getElementById('save').disabled = false;
						console.log('step');
						
					} 

// 					console.log("Changes : " + changes[0][3]);
// 					if(changes[0][0] == 1 || changes[0][0] == 2){
// 						if(changes[0][3] == "" || changes[0][3] == null){
// 							document.getElementById('save').disabled = false;
// 						}
// 					}
					
				  },
                  
                  beforeRemoveRow: function (index, amount) {
                	  var lastIndex = index + amount;
                      var i;
                      for (i = index; i < lastIndex; i++) {
                          console.log("dataProducts=" + JSON.stringify(dataProducts));
                          var deletedProducts = dataProducts[i];
                          var deletedId = deletedProducts.id;

                          console.log("Row = " + i + ";deletedId = " + deletedId);
                          if (deletedId) {
                        	  deletedIds.push(deletedId);
                          }
                      }

                      console.log("list deletedIds=" + deletedIds);
                  },
              });
        	loadProducts();
        });
	

        /**
         * @param vehicleId: -1 means loading all
         */
        function loadProducts(productId) {
        	 document.getElementById('save').disabled = true;
            var url;
            var total = document.getElementById('total');
            
            if (productId === undefined) {
                url = _ctx + 'product/load-product';
            } else {
                url = _ctx + 'product/load-product?id=' + productId;
            }

            $.ajax({
                url : url,
                type : 'GET',
                dataType : 'json',
                contentType : 'application/json',
                success : function(res) {
                    total.innerHTML = res.length;
                    
                    // Update data into the handsontable
                    dataProducts = res;
                    hotProduct.loadData(dataProducts);
                },
                error : function (e) {
                    console.log("Error: " + e);
                }
            });
        }
    </script>
    
    <script>
   
        $('#frmHot').submit(function(e,callback) {
        	 var errorSbm = false;
        	$('#errorName').hide();
        	$('#errorDes').hide();
        	$('#errorNull').hide();
            e.preventDefault();
    
            var frm = $('#frmHot');
            var selectPoolId = $('#poolId').val();
            var frmData = new FormData(this);
    
            // Get header name
            var colHeaderData =  hotProduct.getColHeader();
            
            // Get data from Handsontable
            var tableData = hotProduct.getData();

            
            var frmData = {};
            frmData["header"] = colHeaderData;
            frmData["data"] = tableData;
            frmData["deletedIds"] = deletedIds;

            var a = hotProduct.getDataAtCell(1,2);

			
           
	        for(var i = 0 ; i < dataProducts.length ; i++ ){
	        	console.log(i);
	        	if(!hotProduct.isEmptyRow(i)){
	        		if(hotProduct.getDataAtCell(i,1) == "" || hotProduct.getDataAtCell(i,1) == null   ){
	        			errorSbm = true;
	        			hotProduct.getCellMeta(i,1).valid = false;
	        			 $('#errorName').show(); 
	        			
	        		} else {
	        			hotProduct.getCellMeta(i,1).valid = true;
		        	}
		        	
	        		if(hotProduct.getDataAtCell(i,2) == "" || hotProduct.getDataAtCell(i,2) == null   ){
	        			errorSbm = true;
	        			hotProduct.getCellMeta(i,2).valid = false;
	        			 $('#errorDes').show(); 
	        			
	        		} else {
						hotProduct.getCellMeta(i,2).valid = true;
	        		}
	        	} 
					
	        }

	        

			

	        hotProduct.render();
			console.log(errorSbm);
			if(errorSbm == false){
	            $.ajax({
	                url : _ctx + "product/save",
	                type : "POST",
	                contentType: "application/json",
	                data: JSON.stringify(frmData),
	                dataType: 'json',
	
	                success : function(result) {
	                	 $('#result').fadeToggle('slow'); $('#result').fadeOut(5000); 
	                	 
	                    // reload data
	                	loadProducts();
	                },
	                error : function() {
	                    console.log("Error!");
	                }
	            });
			}
			
        });
    </script>
</body>
</html>