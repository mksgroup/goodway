<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr" xmlns:th="http://www.thymeleaf.org">
<head>
<th:block th:include="fragments/head"></th:block>

</head>
<body>
    <!-- fixed-top-->
    <th:block th:include="fragments/nav"></th:block>
    <!-- ////////////////////////////////////////////////////////////////////////////-->
    <!-- Horizontal navigation-->
    <th:block th:include="fragments/hnav"></th:block>
    <!-- Horizontal navigation-->

    <!-- form body -->
    <th:block th:include="fragments/order/new"></th:block>

    <!-- Dialog to select Customer -->
    <th:block th:include="fragments/customer/select"></th:block>

    <!-- Dialog to select Product -->
    <th:block th:include="fragments/product/select"></th:block>

    <!-- Google Map Modal -->
    <th:block th:include="fragments/order/map"></th:block>


    <!-- footer -->
    <th:block th:include="fragments/footer"></th:block>

    <script>
        // Dispay dialog of addresses
        var selectProductTable = null;
    
        $(document).ready(function() {
            // Load dữ liệu khách hàng
            if (selectProductTable == null) {
                selectProductTable = $("#selectProductTable").DataTable({
                    ajax: {'url': _ctx + 'product/load-product', 'dataSrc': ''},
                    "columns": [
                           {"render": function ( data, type, full, meta ) {

                               return '<input type="checkbox" name="productRow" value="' + full.id + '">';
                           }},  // here's a radio button, modify to use data to populate it
                           { "data": "id" },
                           { "data": "name" },
                           { "data": "description" },
                           { "data": "height" },
                           { "data": "width" },
                           { "data": "length" },
                           { "data": "weight" }     
                    ]
                });
            } else {
                // selectAddressTable.fnDraw();
            }

        });
    </script>
    
    <script>

		$('input[type=search]').on('keyup'), function(){
			var value = $(this).val().toLowerCase();
			$('#selectProductTable tbody tr').filter(function() {
				$(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
			});
		};
	</script>

    <script>
        var dataProducts = [];
        var hotProduct = null;
        var deletedIds = [];
        var invalidFeilds = new Set();
        
        $(function() {
        	var containerProduct = document.getElementById('tableProduct');
            var orderCode = $('#orderCd').val();         

        	hotProduct = new Handsontable(containerProduct, {
                data: dataProducts,
                colHeaders: ["ID", "Tên mặt hàng", "Dài(m)", "Rộng(m)", "Cao(m)", "Trọng lượng (kg)", "Số lượng"],
                colWidths: [50, 300, 100, 100, 100, 120, 100],
                rowHeaders: true,
                minRows: 12,
                currentRowClassName: 'currentRow',
                currentColClassName: 'currentCol',
         	    manualColumnResize: true,
                manualRowResize: true,
                contextMenu: true,
                columns: [
                     { "data": "id", readOnly: true },
                     { "data": "name", readOnly: true },
                     { "data": "height", readOnly: true },
                     { "data": "width", readOnly: true },
                     { "data": "length", readOnly: true },
                     { "data": "weight", readOnly: true },     
                     { "data": "quantity", type: 'numeric'}
               ],
                hiddenColumns: {
                     columns: 7,
                     indicators: true
                },
                afterSelection: function(r,c){
                    if(c==1){
                        displayDlgSelectProduct();
                    }
                },
                beforeRemoveRow: function (index, amount) {
              	  var lastIndex = index + amount;
                    var i;
                    for (i = index; i < lastIndex; i++) {
                        console.log("dataProducts=" + JSON.stringify(dataProducts));
                        var deletedProducts = dataProducts[i];
                        var deletedId = deletedProducts.id;

                        console.log("Row = " + i + ";deletedId = " + deletedId);
                        if (deletedId) {
                      	  deletedIds.push(deletedId);
                        }
                    }

                    console.log("list deletedIds=" + deletedIds);
                },
                afterValidate: function (isValid, value, row, prop, source) {
                    if (!isValid) {
                            var cell = {"row": row, "col": prop};
                            invalidFeilds.add(cell);
                            console.log("cell: " + JSON.stringify(cell));
                    } else {
                    	invalidFeilds.forEach(function(value) {
                    		  if(value.row == row && value.col == prop){
                    			  invalidFeilds.delete(value);
                    		  }
                    		});
                        console.log(invalidFeilds);
                    }
                }
           });
            if(orderCode != ""){   
                loadOrderProduct(orderCode);
                
                $.ajax({
                    url : _ctx + "customer/load-customerBy?orderCd=" + orderCode,

                    success : function(result) {
                        
                        // refresh customer
                        refreshCustomer(result);
                    },
                    error : function() {
                        console.log("Error!");
                    }
                });
            }
     });

        // Load lại danh sách sản phẩm của đơn hàng
        function loadOrderProduct(orderCd) {
            url = _ctx + 'order/load-orderProduct?orderCd=' + orderCd;
                
            $.ajax({
                url : url,
                type : 'GET',
                dataType : 'json',
                contentType : 'application/json',
                success : function(res) {
                    
                    // Update data into the handsontable
                    dataProducts = res;
                    hotProduct.loadData(dataProducts);
                    
                    //Update checked products                                       
                    for(var i = 0; i < res.length; i++){
                        if(res[i].id != null){
                            $("input:checkbox[name=productRow]").each(function(){  
                                if($(this).val() == res[i].id){     
                                    this.checked = true;
                                }
                            }); 
                        }
                    }
                },
                error : function (e) {
                    console.log("Error: " + e);
                }
            });
        }
    </script>

    <!-- Save the order -->
    <script>
        $('#frmOrder').submit(function(e) {
            e.preventDefault();
    
            var frm = $('#frmOrder');
            var orderCd = $('#orderCd').val();
            var address = $('#customer_addr').val();
            var latitude = $('#latitude').val();
            var longitude = $('#longitude').val();
            var customer_id = $('#customer_id').val();
            var customer_name = $('#customer_name').val();
            // Get header name
            var colHeaderData =  hotProduct.getColHeader();
            
            // Get data from Handsontable
            var tableData = hotProduct.getData();

            var frmData = {};
            frmData["productHeader"] = colHeaderData;
            frmData["productData"] = tableData;
            frmData["orderCd"] = orderCd;
            frmData["address"] = address;
            frmData["latitude"] = latitude;
            frmData["longitude"] = longitude;
            frmData["customer_id"] = customer_id;
            frmData["deletedIds"] = deletedIds;

            var ok = true;

            // Check if handsontable row have data but invalid cell.
            for(var row = 0; row < hotProduct.countRows(); row++){
                if(!hotProduct.isEmptyRow(row)){
                    for(var col = 0; col < hotProduct.countCols(); col++){
                        if(hotProduct.getDataAtCell(row, col) == null || hotVehicle.getDataAtCell(row, col) == ""){
                        	hotProduct.getCellMeta(row, col).valid = false;
                            var cell = {"row": row, "col": hotProduct.colToProp(col)};
                            invalidFeilds.add(cell);
                  
                        } else {
                            invalidFeilds.forEach(function(value) {
                                var prop = hotProduct.colToProp(col);
                                if(value.row == row && value.col == prop){
                                    console.log(hotProduct.colToProp(col));
                                    invalidFeilds.delete(value);
                                }
                              });
                        	hotProduct.getCellMeta(row, col).valid = true;
                        }
                    }
                }
            }
            
            hotProduct.render();
            
            // Check if user didn't choose customer.
            if(customer_name == "" || customer_id == "" || orderCd == ""){
            	$('#errorEmpty').fadeToggle('slow'); $('#errorEmpty').fadeOut(10000);
                ok = false;
            } 

            // Check if handsontable have any invalid.
            if(invalidFeilds.size > 0) {
                $("#errorHandsontable").fadeToggle('slow'); $('#errorHandsontable').fadeOut(10000);
                ok = false;
            } 

            // Check if handsontable have any data.
            if(hotProduct.countEmptyRows() == hotProduct.countRows()) { 
                $("#errorHandsontableEmpty").fadeToggle('slow'); $('#errorHandsontableEmpty').fadeOut(10000);
                ok = false;
            } 
            
            console.log(ok);
            if(ok){
                $.ajax({
                    url : _ctx + "order/save",
                    type : "POST",
                    contentType: "application/json",
                    data: JSON.stringify(frmData),
                    dataType: 'json',
    
                    success : function(result) {
                    	$('#result').fadeToggle('slow'); $('#result').fadeOut(5000);
                        
                    },
                    error : function() {
                        console.log("Error!");
                    }
                });
            }
        });
    </script>
    <!--  Scripts for select customer -->
    <script>
        // Dispay dialog of addresses
        var selectCustomerTable = null;
    
        $('#btnSelectCustomer').click(function(e) {
            // Load dữ liệu khách hàng
        	if (selectCustomerTable == null) {
        		selectCustomerTable = $("#selectCustomerTable").DataTable({
                    ajax: {'url': _ctx + 'customer/load-customer', 'dataSrc': ''},
                    "columns": [
                           {"render": function ( data, type, full, meta ) {
                                // return '<input type="radio" name="addressRow" value="' + full.displayAddress + '">';
                               // Assign address id and displayAddress
                        	   return '<input type="radio" name="addressRow" value="' + full.id + '">';
                           }},  // here's a radio button, modify to use data to populate it
                    	   { "data": "id" },
                    	   { "data": "name" },
                    	   { "data": "addr" }
                    ]
                });
        	} else {
        		// selectAddressTable.fnDraw();
            }

            // Hiển thị hộp thoại
        	$("#dlgSearchCustomer").modal('show');
        });

        $('#btnSelectedCustomer').click(function(e) {

            var selectedCustomerId = $('input[name=addressRow]:checked').val();

            // Get Fulll addres from Id
            $.ajax({
                url : _ctx + "customer/load-customer/" + selectedCustomerId,

                success : function(result) {
                    console.log("Load customer result =" + JSON.stringify(result));
                    
                    // fresh address
                    refreshCustomer(result);
                },
                error : function() {
                    console.log("Error!");
                }
            });
        });

        /**
         * @param addrId
         * @param fullAddr
         * @global selectCustomerRow
         */
        function refreshCustomer(customer) {
            // Set address into Address of the Customer
            $('#customer_id').val(customer.id);
            $('#customer_name').val(customer.name);
            $('#customer_phone').val(customer.phone);
            $('#customer_addr').val(customer.addr);

        }
    </script>


    <script async defer th:src="@{https://maps.googleapis.com/maps/api/js?key=} + ${map_key}">
    </script>

    <script> 
        $('#btnShowMap').click(function(e) {
            initMap();
        });
        function initMap(){
            var geocoder = new google.maps.Geocoder();
            var address =  $('#customer_addr').val();
        
            geocoder.geocode({'address': address}, function(results, status) {
                  if (status === 'OK') {
                     console.log(results);
//     	             var map = new google.maps.Map($('#map_canvas'), {
//                    zoom: 15,
//                    center: results[0].geometry.location
//                 });
                     var myOptions = {
    	                       zoom: 15,
                               center: results[0].geometry.location,
                               mapTypeId: google.maps.MapTypeId.ROADMAP
                         };
                 
                     var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
                     var marker = new google.maps.Marker({
                               map: map,
                               position: results[0].geometry.location
                         });

                     $("#googleMapModal").modal('show');
                  } else {
                      alert('Geocode was not successful for the following reason: ' + status);
                  }
 	        });
        }
  </script>

    <script>
        function displayDlgSelectProduct() {
            $("#dlgSearchProduct").modal('show');
        }

        $('#btnSelectedProduct').click(function(e) {
            
            // get selected product's id
            var selectedProducts = [];
            $("input:checkbox[name=productRow]:checked").each(function(){
                selectedProducts.push($(this).val());
            });

            var unSelectedProducts = [];
            $("input:checkbox[name=productRow]:not(:checked)").each(function(){
            	unSelectedProducts.push($(this).val());
            });

            // get product's id already exists in handsontable then remove it from selectedProducts.
            for(var row = 0; row < dataProducts.length; row++){
                if(!hotProduct.isEmptyRow(row)){
                    var data = dataProducts[row];
                    console.log(data.id);
//                 	var index = selectedProducts.indexOf(data.id);
                    
                    for(var index = 0; index < selectedProducts.length; index++){
                        console.log("index:"+index);
                        if(selectedProducts[index] == data.id){
                            console.log(selectedProducts[index]);
                            selectedProducts.splice(index, 1);
                        }
                    }

                    // remove from handsontable if uncheck from selectProductTable
                    for(var index2 = 0; index2 < unSelectedProducts.length; index2++){
                        if(unSelectedProducts[index2] == data.id){
                            console.log(unSelectedProducts[index2] + "-" + row);
                        	dataProducts.splice(row, 1);
                        }
                    }      
                }
            } 
            
            console.log(selectedProducts);
            console.log(unSelectedProducts);
            
            // get product in database
            $.ajax({
                url : _ctx + "product/load-product",
                type : "GET",
                contentType: "application/json",
                dataType: 'json',
                
                success : function(result) {
                  
                    for (var i = 0; i < result.length; i++) {
                        var res = result[i];
                        for(var j = 0; j < selectedProducts.length; j++){
                            var checkedId = selectedProducts[j];
                            
                            if(res.id == checkedId){
                                for(var row = 0; row < dataProducts.length; row++){
//                                         dataProducts.push(res);
    
                                 // add product to handsontable where row's data = null
                                     if(hotProduct.isEmptyRow(row)){
                                        dataProducts.splice(row, 0, res);
                                        break;
                                     }
                                 }
                            }
                        }
                    }
                    
                    hotProduct.loadData(dataProducts);
                },
                error : function() {
                    console.log("Error!");
                }
            });
        });    
//         var product = {"id": res.id,
//                 "name": res.name,
//                 "height": res.height,
//                 "width": res.width,
//                 "length": res.length,
//                 "weight": res.weight,
//                 "quantity": ""
//                };
//  dataProduct.push(product);
  </script>

</body>
</html>